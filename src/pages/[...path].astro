---
import Layout from "../layouts/Layout.astro";
import { getCollection, render } from "astro:content";
import { postPath } from "../utils/post-path";
import TagBadge from "../components/TagBadge.astro";

export async function getStaticPaths() {
  const posts = (await getCollection("blog")).filter((post) => !post.data.draft);
  return posts.map((post) => ({
    params: { path: postPath(post.data.pubDate, post.data.slug).slice(1) },
    props: { post },
  }));
}

const { post } = Astro.props;
const { Content } = await render(post);
const titleHtml = post.data.title.replace(/`([^`]+)`/g, "<code>$1</code>");
---

<Layout
  title={`${post.data.title} â€” Gianfranco's Blog - gian.cool`}
  description={post.data.description}
  ogImage={`${Astro.site}og/${post.data.slug}.png`}
>
  <a
    href="/"
    class="inline-flex items-center gap-1.5 text-sm text-muted dark:text-dark-muted hover:text-ink dark:hover:text-dark-text transition-colors mb-10 group"
  >
    <span class="inline-block transition-transform group-hover:-translate-x-0.5">&larr;</span>
    Back
  </a>

  <article>
    <header class="mb-10">
      <time
        datetime={post.data.pubDate.toISOString()}
        class="text-xs font-mono uppercase tracking-widest text-muted dark:text-dark-muted"
      >
        {
          post.data.pubDate.toLocaleDateString("en-GB", {
            year: "numeric",
            month: "long",
            day: "numeric",
          })
        }
      </time>
      <h1 class="font-serif text-4xl md:text-5xl tracking-tight leading-[1.1] mt-2" set:html={titleHtml} />
      {
        post.data.tags.length > 0 && (
          <div class="mt-4 flex flex-wrap gap-2">
            {post.data.tags.map((tag) => (
              <TagBadge tag={tag} />
            ))}
          </div>
        )
      }
    </header>

    <div class="prose-custom prose-lg dark:prose-invert">
      <Content />
    </div>
  </article>
</Layout>

<script is:inline data-astro-rerun>
  /** Create a progress indicator at the top */
  function createProgressBar() {
    // Create the main container div
    const progressContainer = document.createElement("div");
    progressContainer.className = "progress-container fixed top-0 left-0 z-50 h-1 w-full";

    // Create the progress bar div
    const progressBar = document.createElement("div");
    progressBar.className = "h-1 w-0 bg-terracotta transition-[width] duration-75";
    progressBar.id = "reading-progress-bar";

    // Append the progress bar to the progress container
    progressContainer.appendChild(progressBar);

    // Append the progress container to the document body
    document.body.appendChild(progressContainer);
  }
  createProgressBar();

  /** Update the progress bar when user scrolls */
  function updateScrollProgress() {
    document.addEventListener("scroll", () => {
      const winScroll = document.body.scrollTop || document.documentElement.scrollTop;
      const height = document.documentElement.scrollHeight - document.documentElement.clientHeight;
      const scrolled = (winScroll / height) * 100;
      const progressBar = document.getElementById("reading-progress-bar");
      if (progressBar) {
        progressBar.style.width = scrolled + "%";
      }
    });
  }
  updateScrollProgress();
</script>
