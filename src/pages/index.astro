---
import Layout from "../layouts/Layout.astro";
import { getCollection, render } from "astro:content";
import { postPath } from "../utils/post-path";
import ExcerptOnly from "../components/ExcerptOnly.astro";

const posts = (await getCollection("blog"))
  .filter((post) => !post.data.draft)
  .sort((a, b) => a.data.pubDate.getTime() - b.data.pubDate.getTime());

// Render posts to get the Content component
const postsWithContent = await Promise.all(
  posts.map(async (post) => {
    const { Content } = await render(post);
    return {
      post,
      Content,
    };
  }),
);
---

<Layout title="Gianfranco's Blog - gian.cool">
  <header class="mb-16 md:mb-20">
    <h1 class="font-serif text-5xl md:text-5xl tracking-tight leading-[1.1]">
      Gian.cool
      <span class="block text-muted dark:text-dark-muted text-3xl md:text-3xl italic mt-1">Gianfranco's blog</span>
    </h1>
  </header>

  <section>
    <ul class="space-y-12">
      {
        postsWithContent.map(({ post, Content }) => (
          <li class="group">
            <a href={postPath(post.data.pubDate, post.data.slug)} class="block">
              <time
                datetime={post.data.pubDate.toISOString()}
                class="text-xs font-mono uppercase tracking-widest text-muted dark:text-dark-muted"
              >
                {post.data.pubDate.toLocaleDateString("en-GB", {
                  year: "numeric",
                  month: "short",
                  day: "numeric",
                })}
              </time>
              <h2 class="font-serif text-2xl md:text-3xl mt-1.5 group-hover:text-terracotta dark:group-hover:text-dark-terracotta transition-colors duration-200">
                {post.data.title}
              </h2>
            </a>
            <div
              class="mt-3 prose prose-sm max-w-none
              prose-headings:font-serif prose-headings:tracking-tight prose-headings:font-normal
              prose-h2:text-xl prose-h2:mt-4 prose-h2:mb-2
              prose-p:leading-relaxed prose-p:text-muted dark:prose-p:text-dark-muted
              prose-strong:text-ink dark:prose-strong:text-dark-text
              prose-a:text-terracotta dark:prose-a:text-dark-terracotta prose-a:pointer-events-none
              prose-li:text-muted dark:prose-li:text-dark-muted
              prose-code:text-xs prose-code:font-mono prose-code:bg-ink/5 dark:prose-code:bg-dark-text/5 prose-code:px-1 prose-code:py-0.5 prose-code:rounded
            "
            >
              <ExcerptOnly>
                <Content />
              </ExcerptOnly>
            </div>
            <a
              href={postPath(post.data.pubDate, post.data.slug)}
              class="inline-block mt-2 text-sm text-terracotta dark:text-dark-terracotta hover:underline underline-offset-2"
            >
              Read more â†’
            </a>
          </li>
        ))
      }
    </ul>
  </section>
</Layout>
