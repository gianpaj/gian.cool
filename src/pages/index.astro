---
import Layout from "../layouts/Layout.astro";
import { getCollection } from "astro:content";
import MarkdownIt from "markdown-it";
import { postPath } from "../utils/post-path";

const parser = new MarkdownIt();

const posts = (await getCollection("blog"))
  .filter((post) => !post.data.draft)
  .sort((a, b) => b.data.pubDate.getTime() - a.data.pubDate.getTime());

function truncateMarkdown(body: string | undefined, maxLen = 500): string {
  if (!body) return "";
  // Walk through the raw markdown counting only visible text characters.
  // When we hit maxLen, trim to the last word boundary and stop.
  let textCount = 0;
  let cutIndex = body.length;

  for (let i = 0; i < body.length; i++) {
    const ch = body[i];
    // Skip markdown syntax that doesn't produce visible text
    // but keep it in the output so markdown-it renders it correctly.
    // We only count characters that will appear as text.
    if (ch === "\n" || ch === "\r") {
      // newlines don't count as visible text
      continue;
    }
    textCount++;
    if (textCount >= maxLen) {
      cutIndex = i + 1;
      break;
    }
  }

  if (cutIndex >= body.length) return parser.render(body);

  // Trim to last space for a clean word boundary
  let trimmed = body.slice(0, cutIndex);
  const lastSpace = trimmed.lastIndexOf(" ");
  if (lastSpace > 0) {
    trimmed = trimmed.slice(0, lastSpace);
  }

  const html = parser.render(trimmed);
  // Append ellipsis inside the last closing tag
  return html.replace(/<\/([^>]+)>\s*$/, "\u2026</$1>");
}
---

<Layout title="Gian.cool Blog">
  <header class="mb-16 md:mb-20">
    <h1 class="font-serif text-5xl md:text-5xl tracking-tight leading-[1.1]">
      Gian.cool
      <span class="block text-muted dark:text-dark-muted text-3xl md:text-3xl italic mt-1">Gianfranco's blog</span>
    </h1>
  </header>

  <section>
    <ul class="space-y-12">
      {
        posts.map((post) => (
          <li class="group">
            <a href={postPath(post.data.pubDate, post.data.slug)} class="block">
              <time
                datetime={post.data.pubDate.toISOString()}
                class="text-xs font-mono uppercase tracking-widest text-muted dark:text-dark-muted"
              >
                {post.data.pubDate.toLocaleDateString("en-GB", {
                  year: "numeric",
                  month: "short",
                  day: "numeric",
                })}
              </time>
              <h2 class="font-serif text-2xl md:text-3xl mt-1.5 group-hover:text-terracotta dark:group-hover:text-dark-terracotta transition-colors duration-200">
                {post.data.title}
              </h2>
            </a>
            <div
              class="mt-3 prose prose-sm max-w-none
              prose-headings:font-serif prose-headings:tracking-tight prose-headings:font-normal
              prose-h2:text-xl prose-h2:mt-4 prose-h2:mb-2
              prose-p:leading-relaxed prose-p:text-muted dark:prose-p:text-dark-muted
              prose-strong:text-ink dark:prose-strong:text-dark-text
              prose-a:text-terracotta dark:prose-a:text-dark-terracotta prose-a:pointer-events-none
              prose-li:text-muted dark:prose-li:text-dark-muted
              prose-code:text-xs prose-code:font-mono prose-code:bg-ink/5 dark:prose-code:bg-dark-text/5 prose-code:px-1 prose-code:py-0.5 prose-code:rounded
            "
              set:html={truncateMarkdown(post.body)}
            />
          </li>
        ))
      }
    </ul>
  </section>
</Layout>
