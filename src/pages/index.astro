---
import Layout from "../layouts/Layout.astro";
import { getCollection, render } from "astro:content";
import { postPath } from "../utils/post-path";
import ExcerptOnly from "../components/ExcerptOnly.astro";

const posts = (await getCollection("blog"))
  .filter((post) => !post.data.draft)
  .sort((a, b) => b.data.pubDate.getTime() - a.data.pubDate.getTime())
  .slice(0, 10);

// Render posts to get the Content component
const postsWithContent = await Promise.all(
  posts.map(async (post) => {
    const { Content } = await render(post);
    return {
      post,
      Content,
    };
  }),
);
---

<Layout title="Gianfranco's Blog - gian.cool">
  <header class="mb-16 md:mb-20">
    <h1 class="font-serif text-5xl md:text-5xl tracking-tight leading-[1.1]">
      Gian.cool
      <span class="block text-muted dark:text-dark-muted text-3xl md:text-3xl italic mt-1">Gianfranco's blog</span>
    </h1>
  </header>

  <section>
    <ul class="space-y-12">
      {
        postsWithContent.map(({ post, Content }) => (
          <li class="group">
            <a href={postPath(post.data.pubDate, post.data.slug)} class="block">
              <time
                datetime={post.data.pubDate.toISOString()}
                class="text-xs font-mono uppercase tracking-widest text-muted dark:text-dark-muted"
              >
                {post.data.pubDate.toLocaleDateString("en-GB", {
                  year: "numeric",
                  month: "short",
                  day: "numeric",
                })}
              </time>
              <h2
                class="font-serif text-2xl md:text-3xl mt-1.5 group-hover:text-terracotta transition-colors duration-200"
                set:html={post.data.title.replace(/`([^`]+)`/g, "<code>$1</code>")}
              />
            </a>
            <div class="mt-3 prose-custom prose-lg dark:prose-invert">
              <ExcerptOnly>
                <Content />
              </ExcerptOnly>
            </div>
            <a
              href={postPath(post.data.pubDate, post.data.slug)}
              class="inline-block mt-2 text-sm text-terracotta hover:underline underline-offset-2"
            >
              Read more â†’
            </a>
          </li>
        ))
      }
    </ul>
  </section>
</Layout>
