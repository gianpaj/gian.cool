# Blog Tags Plan (Corrected for Current Routing)

## 1. Goals and Constraints

### Goals

- Add tags to blog posts with strict validation.
- Keep existing post URLs unchanged (`/YYYY/mon/DD/slug`).
- Add tag archive pages and a tags index.
- Exclude draft posts from all public tag surfaces (pages, counts, links).

### Explicit Constraints
- Keep `src/pages/index.astro` as the homepage list.
- Keep `src/pages/[...path].astro` as the post route entrypoint.
- Do not introduce a `/blog/*` route tree.

### Non-Goals (for this phase)
- No large visual redesign.
- No client-side multi-tag filtering UI on homepage.
- No tag-based RSS feeds yet.

---

## 2. Proposed URL Structure

### Keep Existing Post URLs
- Post pages remain generated by `postPath(pubDate, slug)` in `src/utils/post-path.ts`.
- Example: `/2026/feb/06/opus-4-6-vs-codex-5-3`

### Add New Tag URLs
- Tags directory: `/tags`
- Single tag archive: `/tags/[tag]`

This avoids regressions and preserves current SEO/canonical behavior for existing posts.

---

## 3. Tag Taxonomy (Single Source of Truth)

Create one canonical tag module and import it everywhere.

**File:** `src/data/tags.ts`

```ts
export const VALID_TAGS = [
  "ai",
  "audio",
  "llm",
  "coding",
  "coding_agent",
  "terminal",
  "github",
  "workflow",
  "tools",
  "macos",
  "web",
  "projects",
  "benchmark",
  "comparison",
  "guide",
  "review",
  "models",
] as const;

export type Tag = (typeof VALID_TAGS)[number];

export const TAG_METADATA: Record<Tag, { label: string; description: string }> = {
  ai: { label: "AI", description: "LLMs, agents, and AI workflows" },
  audio: { label: "Audio", description: "Audio processing and tools" },
  llm: { label: "LLM", description: "Large Language Models" },
  coding: { label: "Coding", description: "Software development and programming" },
  coding_agent: { label: "Coding Agent", description: "AI agents for coding" },
  terminal: { label: "Terminal", description: "CLI tools and shell workflows" },
  github: { label: "GitHub", description: "GitHub tooling and workflows" },
  workflow: { label: "Workflow", description: "Productivity and process" },
  tools: { label: "Tools", description: "Software and utilities" },
  macos: { label: "macOS", description: "Apple desktop platform" },
  web: { label: "Web", description: "Web development topics" },
  projects: { label: "Projects", description: "Build logs and project write-ups" },
  benchmark: { label: "Benchmark", description: "Performance and measurements" },
  comparison: { label: "Comparison", description: "A vs B analysis" },
  guide: { label: "Guide", description: "How-to content" },
  review: { label: "Review", description: "Opinionated evaluations" },
  models: { label: "Models", description: "Model-level analysis and results" },
};
```

Notes:
- `audio`, `llm`, and `coding_agent` are included to match implemented post tags.
- Do not duplicate `VALID_TAGS` in other files.

---

## 4. Content Schema Changes (Enforced Validation)

Update blog schema in `src/content.config.ts` to validate tags against `VALID_TAGS`.

```ts
import { defineCollection, z } from "astro:content";
import { glob } from "astro/loaders";
import { VALID_TAGS } from "./data/tags";

const blog = defineCollection({
  loader: glob({ pattern: "**/[^_]*.{md,mdx}", base: "./src/data/blog" }),
  schema: z.object({
    title: z.string(),
    description: z.string(),
    slug: z.string(),
    draft: z.boolean().default(false),
    pubDate: z.coerce.date(),
    updatedDate: z.coerce.date().optional(),
    tags: z.array(z.enum(VALID_TAGS)).default([]),
  }),
});

export const collections = { blog };
```

Outcome:
- Invalid tags fail at build/check time.
- Tag type safety is real, not just documented.

---

## 5. UI and Page Changes

### 5.1 Add Tag Badge Component

**File:** `src/components/TagBadge.astro`

Behavior:
- Inputs: `tag` (required), `href` (optional, defaults to `/tags/${tag}`).
- Renders an anchor for consistent navigation.
- Uses label from `TAG_METADATA`.

No unused `interactive` prop.

### 5.2 Homepage (`src/pages/index.astro`)

Keep current layout and excerpt flow.

Changes:
- Display post tags under each post preview.
- Use `TagBadge` for each tag.
- Keep existing sort/order and draft filtering.

No client-side filter script in this phase.

### 5.3 Post Page (`src/pages/[...path].astro`)

Changes:
- Render tags near post header or footer using `TagBadge`.
- Keep `getStaticPaths()` and `postPath()` logic unchanged.

### 5.4 Tag Directory Page

**New file:** `src/pages/tags.astro`

Behavior:
- Read only published posts (`!post.data.draft`).
- Aggregate tag counts from published posts only.
- Sort by count desc, then tag asc.
- Link each tag to `/tags/[tag]`.

### 5.5 Dynamic Tag Page

**New file:** `src/pages/tags/[tag].astro`

Behavior:
- `getStaticPaths()` derives tags from published posts only.
- Guard against invalid tag params using `VALID_TAGS`.
- Show posts where `post.data.tags.includes(tag)` and `!post.data.draft`.
- If no posts for a tag (should be rare), show empty-state copy.

Important:
- Import `TAG_METADATA` from `src/data/tags.ts` (single source).

---

## 6. Draft Exclusion Rules

Apply consistently in all tag-related logic:
- Tag path generation (`/tags/[tag]`)
- Tag counts on `/tags`
- Post listings on `/tags/[tag]`
- Optional future sitemap/RSS tag surfaces

Rule: always filter with `!post.data.draft` before reading tags.

---

## 7. Post Frontmatter Migration

Update existing posts to include `tags` arrays.

Suggested mapping:
- `audioslim.mdx`: `coding`, `projects`, `audio`, `tools`, `macos`
- `github-actions-terminal-monitoring.mdx` (draft): `ai`, `coding_agent`, `terminal`, `github`, `workflow`
- `opus-4-6-vs-codex-5-3.mdx`: `llm`, `benchmark`, `comparison`

Because drafts are excluded from public aggregation, draft tags are safe to keep for future publish.

---

## 8. Implementation Sequence

1. Create `src/data/tags.ts` with `VALID_TAGS`, `Tag`, and `TAG_METADATA`.
2. Update `src/content.config.ts` schema to enforce tag validation.
3. Add `src/components/TagBadge.astro`.
4. Update `src/pages/index.astro` to render tags on previews.
5. Update `src/pages/[...path].astro` to render tags on post pages.
6. Add `src/pages/tags.astro` with published-only counts.
7. Add `src/pages/tags/[tag].astro` with published-only static paths and listings.
8. Add `tags` frontmatter to current posts.

---

## 9. Validation Checklist

Run:

```bash
pnpm astro check
pnpm build
pnpm test:run
```

Verify manually:
- Existing post URLs still resolve via date paths.
- Homepage still renders excerpts and now shows tags.
- `/tags` lists expected tags and counts.
- `/tags/[tag]` pages exist only for tags used by published posts.
- Draft post tags do not appear in `/tags` or tag archives.

---

## 10. Risks and Mitigations

- Risk: Tag constant drift across files.
  - Mitigation: one canonical `src/data/tags.ts` import source.

- Risk: Invalid tags silently accepted.
  - Mitigation: schema-level `z.enum(VALID_TAGS)`.

- Risk: Draft leakage in public tag surfaces.
  - Mitigation: always filter published posts first.

- Risk: Route/SEO regressions.
  - Mitigation: no changes to `postPath()` or `[...path].astro` route strategy.

---

## 11. Optional Phase 2 Enhancements

- Add homepage tag filtering (URL-driven, progressive enhancement, no fragile DOM parsing).
- Add related posts section by shared tags on post pages.
- Add `/tags/[tag]/feed.xml`.
